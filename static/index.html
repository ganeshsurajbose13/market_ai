<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Market AI ‚Äì Full Engine View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { background:#0f172a; color:#e5e7eb; font-family:Arial; margin:0 }
.container { max-width:1200px; margin:auto; padding:20px }
h1 { text-align:center; color:#38bdf8 }
input { width:60%; padding:12px; font-size:16px; border-radius:6px; border:none }
button { padding:12px 20px; background:#22c55e; border:none; border-radius:6px; cursor:pointer }
button:hover { background:#16a34a }
.card { background:#020617; border-radius:10px; padding:16px; margin-top:20px }
.signal { font-size:30px; font-weight:bold; text-align:center }
.STRONG { color:#22c55e }
.BUY { color:#4ade80 }
.HOLD { color:#eab308 }
.SELL { color:#ef4444 }
.center { text-align:center; margin-top:6px }
table { width:100%; border-collapse:collapse; margin-top:10px }
th, td { padding:8px; border-bottom:1px solid #334155; text-align:center }
th { color:#38bdf8 }
ul { padding-left:20px }
.loading { text-align:center; font-size:18px }
hr { border:1px solid #334155; margin:30px 0 }
</style>
</head>

<body>
<div class="container">
<h1>üìà Market AI ‚Äì Primary & Combo Engine</h1>

<div style="text-align:center;">
    <input id="symbol" value="SBIN.NS">
    <button onclick="analyze()">Analyze</button>
</div>

<div id="output"></div>
</div>

<script>
async function analyze() {
    const symbol = document.getElementById("symbol").value.trim();
    const out = document.getElementById("output");

    out.innerHTML = `<div class="loading">‚è≥ Analyzing ${symbol}...</div>`;

    try {
        const res = await fetch(`/analyze?symbol=${symbol}`);
        const json = await res.json();

        console.log("FULL RESPONSE", json);

        const P = json.primary_engine;
        const C = json.combo_engine;

        out.innerHTML = `
        ${engineBlock("PRIMARY ENGINE", P, true)}
        <hr>
        ${engineBlock("COMBO ENGINE", C, false)}
        `;
    }
    catch (e) {
        console.error(e);
        out.innerHTML = "‚ùå JavaScript error ‚Äì check console";
    }
}

function engineBlock(title, d, showProb) {
    let cls = "HOLD";
    if (d.final_signal.includes("STRONG")) cls = "STRONG";
    else if (d.final_signal.includes("BUY")) cls = "BUY";
    else if (d.final_signal.includes("SELL")) cls = "SELL";

    return `
    <div class="card">
        <h2 style="text-align:center">${title}</h2>
        <div class="signal ${cls}">${d.final_signal}</div>

        <div class="center">
            ${showProb ? `Probability: <b>${d["probability_%"]}%</b>` : 
            `Confidence: <b>${d["confidence_score_%"]}% (${d.confidence_band})</b>`}
        </div>

        <div class="center">
            AI Model: <b>${d.ai_model}</b> |
            AI Trend: <b>${d.ai_trend ?? d.ai_model}</b>
        </div>

        <div class="center">
            Regression: <b>${d.regression_trend}</b> |
            Daily: <b>${d.daily_trend ?? "N/A"}</b> |
            Weekly: <b>${d.weekly_trend}</b> |
            Monthly: <b>${d.monthly_trend}</b>
        </div>

        <div class="center">
            SL: <b>${d.stop_loss ?? d.risk?.stop_loss}</b> |
            Target: <b>${d.target ?? d.risk?.target}</b>
        </div>

        <div class="center">
            Options Signal: <b>${d.options_chain?.signal}</b>
        </div>
    </div>

    ${analysisTable(d.analysis)}

    ${d.forecast ? forecastBlock(d.forecast) : ""}

    <div class="card">
        <h3>üß† Reasons</h3>
        <ul>${(d.reason || []).map(r => `<li>${r}</li>`).join("")}</ul>
    </div>
    `;
}

function analysisTable(a) {
    if (!a) return "";
    return `
    <div class="card">
        <h3>üìä EMA + VWAP Analysis</h3>
        <table>
            <tr>
                <th>TF</th><th>Price</th><th>VWAP</th>
                <th>EMA5</th><th>EMA10</th><th>EMA20</th><th>Bias</th>
            </tr>
            ${row("Daily", a.Daily)}
            ${a["1H"] ? row("1H", a["1H"]) : ""}
            ${a["4H"] ? row("4H", a["4H"]) : ""}
        </table>
    </div>`;
}

function forecastBlock(f) {
    return `
    <div class="card">
        <h3>üîÆ Forecast</h3>
        <b>Daily (5 Days):</b> ${f.daily_next_5_days.join(", ")}<br>
        <b>Weekly (5 Weeks):</b> ${f.weekly_next_5_weeks.join(", ")}<br>
        <b>Monthly (5 Months):</b> ${f.monthly_next_5_months.join(", ")}<br>
        <b>AI (5 Days):</b> ${f.ai_next_5_days.join(", ")}
    </div>`;
}

function row(tf, d) {
    return `
    <tr>
        <td>${tf}</td>
        <td>${d.Price}</td>
        <td>${d.VWAP}</td>
        <td>${d.EMA_5}</td>
        <td>${d.EMA_10}</td>
        <td>${d.EMA_20}</td>
        <td>${d.Bias}</td>
    </tr>`;
}
</script>
</body>
</html>
